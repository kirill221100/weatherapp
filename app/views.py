import requests, datetime, random
from flask import flash, session, redirect, request, url_for, render_template
from app import app, scheduler
from app.config import Config as cfg
from app.forms import OptionsForm



def get_weather_data(city, som):
    if som == standart:
        url = f'http://api.openweathermap.org/data/2.5/weather?q={ city }&units=standart&lang=ru&appid={ cfg.API }'
    elif som == imperial:
        url = f'http://api.openweathermap.org/data/2.5/weather?q={city}&units=imperial&lang=ru&appid={cfg.API}'
    else:
        url = f'http://api.openweathermap.org/data/2.5/weather?q={city}&units=metric&lang=ru&appid={cfg.API}'
    r = requests.get(url).json()
    return r

standart = {'temp': 'K', 'speed': 'метр/сек.'}
imperial = {'temp': 'F', 'speed': 'миль/час'}
metric = {'temp': 'C', 'speed': 'метр/сек.'}
#usd, eur, news = None, None, [{'source': {'id': None, 'name': 'Gazeta.ru'}, 'author': None, 'title': 'Власти Мариуполя сообщили об эвакуации мирного населения - Газета.Ru', 'description': 'Власти Мариуполя сообщили, что эвакуация мирного населения начнется в\xa011.00 (12.00 мск) в\xa0направлении Запорожья, передает ТАСС .', 'url': 'https://www.gazeta.ru/social/news/2022/03/05/17383633.shtml', 'urlToImage': 'https://img.gazeta.ru/files3/243/14572243/upload-AP22055237311670-pic_32ratio_900x600-900x600-77725.jpg', 'publishedAt': '2022-03-05T07:49:09Z', 'content': None}, {'source': {'id': None, 'name': 'Sports.ru'}, 'author': 'Лина Лоцик', 'title': 'Девон Кершоу: «Надеюсь, что Непряева закончит сезон с Большим хрустальным глобусом. Мне плевать, под каким фла - Sports.ru', 'description': 'Чемпион мира по лыжным гонкам канадец Девон Кершоу высказался о возможной победе Натальи Непряевой в общем зачете Кубка мира.', 'url': 'https://www.sports.ru/skiing/1107404731-devon-kershou-nadeyus-chto-nepryaeva-zakonchit-sezon-s-bolshim-xrustal.html', 'urlToImage': 'https://www.sports.ru/dynamic_images/news/110/740/473/1/share/618afc.jpg', 'publishedAt': '2022-03-05T07:26:00Z', 'content': '.\xa0\r\n .\xa0\r\n« . , , , . , . , .\r\n ( ) , . , .\r\n , , . , . .\r\n , », FasterSkier.\r\n : , FIS'}, {'source': {'id': None, 'name': 'Gazeta.ru'}, 'author': None, 'title': 'В Минобороны России заявили об уничтожении склада боеприпасов с Javelin в Житомире - Газета.Ru', 'description': 'Военные России высокоточным оружием уничтожили большой склад с\xa0противотанковыми ракетными комплексами, находящийся в\xa0Житомире. Об этом заявил официальный представитель Министерства обороны России генерал-майор Игорь Конашенков.', 'url': 'https://www.gazeta.ru/army/news/2022/03/05/17383387.shtml', 'urlToImage': 'https://img.gazeta.ru/files3/356/12879356/RIAN_5777353.HR-pic_32ratio_900x600-900x600-97434.jpg', 'publishedAt': '2022-03-05T07:15:41Z', 'content': None}, {'source': {'id': 'lenta', 'name': 'Lenta'}, 'author': 'Варвара Кошечкина', 'title': 'Минобороны России рассказало о ходе боев за Мариуполь - Lenta.ru', 'description': 'Военнослужащие Донецкой народной республики (ДНР) продолжают сжимать кольцо окружения вокруг Мариуполя, рассказал официальный представитель Министерства обороны России генерал-майор Игорь Конашенков.Он добавил, что по вошедшим в Мариуполь подразделениям Народ…', 'url': 'https://lenta.ru/news/2022/03/05/mariupol_min/', 'urlToImage': 'https://icdn.lenta.ru/images/2022/03/05/10/20220305100457474/share_d6f23c6c11e7939a7f20564fe585520d.jpg', 'publishedAt': '2022-03-05T07:03:00Z', 'content': ''}, {'source': {'id': None, 'name': 'Cnews.ru'}, 'author': None, 'title': 'Созданная россиянами знаменитая ИТ-компания прекращает работу в России - CNews.ru', 'description': 'Созданная выпускниками МФТИ ИТ-компания Acronis прекращает работу в Россию. Судьба ее российского центра разработки...', 'url': 'https://www.cnews.ru/news/top/2022-03-05_sozdannaya_rossiyanami_znamenitaya', 'urlToImage': 'https://filearchive.cnews.ru/img/news/2022/03/05/beloussov600.jpg', 'publishedAt': '2022-03-05T07:01:49Z', 'content': '- Acronis . .\r\nAcronis \r\n Acronis . (Patrick Pulvermueller) . \r\n , , Acronis Cyber Foundation $500 . Acronis . \r\n , , , , . \r\n Acronis \r\nAcronis . 2001 . SWsoft, - (): , , .\r\nSWsoft , - «-». 2003 . A… [+165 chars]'}, {'source': {'id': None, 'name': 'Igromania.ru'}, 'author': None, 'title': 'Steam начал изымать Elden Ring у российских игроков и оформлять возвраты - Игромания онлайн', 'description': 'Судя по всему, причина в банковских санкциях.', 'url': 'https://www.igromania.ru/news/114138/Steam_nachal_izymat_Elden_Ring_u_rossiyskih_igrokov_i_oformlyat_vozvraty.html', 'urlToImage': 'https://cdn.igromania.ru/mnt/news/e/f/5/c/7/0/114138/6ebb3fb00831de10_1200xH.jpg', 'publishedAt': '2022-03-05T06:38:01Z', 'content': None}, {'source': {'id': 'google-news', 'name': 'Google News'}, 'author': None, 'title': 'Росавиация продлила запрет на полеты в 11 аэропортов юга РФ до 14 марта - Интерфакс', 'description': None, 'url': 'https://news.google.com/__i/rss/rd/articles/CBMiJWh0dHBzOi8vd3d3LmludGVyZmF4LnJ1L3J1c3NpYS84MjY0NjbSASJodHRwczovL3d3dy5pbnRlcmZheC5ydS9hbXAvODI2NDY2?oc=5', 'urlToImage': None, 'publishedAt': '2022-03-05T06:33:39Z', 'content': None}, {'source': {'id': None, 'name': 'Gazeta.ru'}, 'author': None, 'title': 'Спецоперация ВС России на территории Украины идет десятые сутки - Газета.Ru', 'description': 'Идут десятые сутки спецоперации России на\xa0Украине. Президент Владимир Путин подписал закон об уголовном наказании за\xa0фейки о\xa0российской армии и призывы к\xa0антироссийским санкциям. Роскомнадзор решил заблокировать доступ к\xa0Facebook и Twitter. Тем временем Samsu…', 'url': 'https://www.gazeta.ru/politics/2022/03/05/14601589.shtml', 'urlToImage': 'https://img.gazeta.ru/files3/595/14601595/RIAN_8132217.HR-pic_32ratio_900x600-900x600-99611.jpg', 'publishedAt': '2022-03-05T06:24:17Z', 'content': None}, {'source': {'id': 'lenta', 'name': 'Lenta'}, 'author': 'Мария Гейн', 'title': 'Российская авиакомпания отменила полеты в несколько стран - Lenta.ru', 'description': 'Российская авиакомпания «Уральские авиалинии» до 26 марта отменяет рейсы в ОАЭ, Армению, Израиль и Азербайджан. Полеты в несколько стран не будут выполняться в связи со сложившейся геополитической ситуацией. В ОАЭ, Армению и Израиль авиакомпания перестанет ле…', 'url': 'https://lenta.ru/news/2022/03/05/noflightsagain/', 'urlToImage': 'https://icdn.lenta.ru/images/2022/03/05/09/20220305092804760/share_4e6b35c00fea92e85d7568643ffff6d7.jpg', 'publishedAt': '2022-03-05T06:24:00Z', 'content': ''}, {'source': {'id': None, 'name': 'Sportrbc.ru'}, 'author': None, 'title': 'Ассоциация европейских лиг исключила РПЛ из своего состава - РБК Спорт', 'description': 'В заявлении организации отмечается, что решение принято из-за «текущих экстраординарных и трагических обстоятельств»', 'url': 'https://sportrbc.ru/news/6222ef159a794767425f6968', 'urlToImage': 'https://s0.rbk.ru/v6_top_pics/media/img/9/99/756464579387999.jpg', 'publishedAt': '2022-03-05T06:05:00Z', 'content': '(European Leagues) «»\xa0— - () () - . - .\r\n« European Leagues »,\xa0— .\r\n 2007 .\r\n28 . () , « , », (CAS).\r\n24 , «». , « ».'}, {'source': {'id': None, 'name': 'Kommersant.ru'}, 'author': None, 'title': 'Правительство выделило 500 млн рублей МСП, пользующемуся системой быстрых платежей - Коммерсантъ', 'description': 'Подробнее на сайте', 'url': 'https://www.kommersant.ru/doc/5248983', 'urlToImage': 'https://im.kommersant.ru/SocialPics/5248983_26_0_1287985033', 'publishedAt': '2022-03-05T06:01:06Z', 'content': '(), . 500 ., - .\r\n - . . 1 2022 , «».\r\n . , . 0,7% .\r\n , - , 24 . « » , .\r\n «» «, ».'}, {'source': {'id': None, 'name': 'Gazeta.ru'}, 'author': None, 'title': 'Нетребко решила прекратить выступления - Газета.Ru', 'description': 'Максим Берин, представитель оперной певицы Анны Нетребко, заявил РИА «Новости» , что она решила приостановить свою деятельность.', 'url': 'https://www.gazeta.ru/culture/news/2022/03/05/n_17383087.shtml', 'urlToImage': 'https://img.gazeta.ru/files3/582/13997582/upload-20060927_gaf_ri02_016-pic_32ratio_900x600-900x600-44906.jpg', 'publishedAt': '2022-03-05T05:51:23Z', 'content': None}, {'source': {'id': 'lenta', 'name': 'Lenta'}, 'author': 'Марина Совина', 'title': 'Белорусские паралимпийцы уехали из Пекина - Lenta.ru', 'description': 'Белорусская делегация уехала из Пекина, где в настоящее время проходят зимние Паралимпийские игры. Об этом заявил представитель Международного паралимпийского комитета (МПК) Крэйг Спенс. 3 марта МПК отказался допустить российских и белорусских спортсменов до …', 'url': 'https://lenta.ru/news/2022/03/05/para_bel/', 'urlToImage': 'https://icdn.lenta.ru/images/2022/03/05/08/20220305080051034/share_23b9011b57c421d6a474ec3b82bbb543.jpg', 'publishedAt': '2022-03-05T05:01:00Z', 'content': None}, {'source': {'id': None, 'name': 'Ura.news'}, 'author': None, 'title': 'Зеленский: Украина создаст ядерное оружие из-за НАТО - URA.RU', 'description': 'Читайте на URA.RU', 'url': 'https://ura.news/news/1052536726', 'urlToImage': 'https://s.ura.news/images/news/upload/smm/2022/03/05/facebook_c5a00e7f0b14e3e962dbdd71ece79629.jpg', 'publishedAt': '2022-03-05T04:19:00Z', 'content': '- \xa0 , . \xa0 \xa0 , \xa0 telegram-.\r\n«, \xa0 ,\xa0— 50 . , \xa0 , \xa0 . \xa0 . \xa0\xa0, \xa0 \xa0\xa0 . \xa0 \xa0\xa0 »,\xa0— .\r\n , , \xa0 \xa01994 . , , \xa0 . \xa0 \xa0 .\r\n \xa0 \xa0 . \xa0 \xa0 , \xa0 \xa0 . , \xa0 \xa0 , \xa0 .\r\n \xa0URA.RU \xa0Google News\r\n, .\r\n \xa0\xa0 \xa0.\r\n, \xa0 \xa0 \xa0telegram- URA.… [+13 chars]'}, {'source': {'id': 'lenta', 'name': 'Lenta'}, 'author': 'Марина Совина', 'title': 'Президент Финляндии назвал ответственного за решение о вхождении в НАТО - Lenta.ru', 'description': 'Президент Финляндии Саули Ниинисте заявил, что решение о вступлении страны в НАТО должен принимать парламент страны. По словам Ниинисте, он понимает, что НАТО держит открытыми свои двери для потенциального присоединения новых членов к организации. Президент о…', 'url': 'https://lenta.ru/news/2022/03/05/vstuplenie/', 'urlToImage': 'https://icdn.lenta.ru/images/2022/03/05/06/20220305062810922/share_b5516c61dc48ca582162ddc93627a4d6.jpg', 'publishedAt': '2022-03-05T03:35:57Z', 'content': '. : Hannah McKay / Reuters'}, {'source': {'id': 'google-news', 'name': 'Google News'}, 'author': None, 'title': 'Экс-премьер Украины рассказал о бункере Зеленского на случай ядерного удара - Московский Комсомолец', 'description': None, 'url': 'https://news.google.com/__i/rss/rd/articles/CBMidmh0dHBzOi8vd3d3Lm1rLnJ1L3BvbGl0aWNzLzIwMjIvMDMvMDUvZWtzcHJlbWVyLXVrcmFpbnktcmFzc2themFsLW8tYnVua2VyZS16ZWxlbnNrb2dvLW5hLXNsdWNoYXkteWFkZXJub2dvLXVkYXJhLmh0bWzSAQA?oc=5', 'urlToImage': None, 'publishedAt': '2022-03-05T01:02:15Z', 'content': None}, {'source': {'id': 'lenta', 'name': 'Lenta'}, 'author': 'Марина Совина', 'title': 'Samsung остановила поставки смартфонов в Россию - Lenta.ru', 'description': 'Южнокорейская компания Samsung приостанавливает поставки телефонов и микрочипов в Россию. В корпорации уточнили, что в связи с геополитической обстановкой в мире временно прекращается экспорт на территорию России всей продукции компании. 1 марта о прекращении…', 'url': 'https://lenta.ru/news/2022/03/05/smsng/', 'urlToImage': 'https://icdn.lenta.ru/images/2022/03/05/02/20220305021507455/share_138e599ca84c2f8a8a9f0750df413241.jpg', 'publishedAt': '2022-03-04T23:15:00Z', 'content': 'Samsung . .\r\n , .\r\n1 Apple . , , Apple Pay. 3 Apple , , .'}, {'source': {'id': 'google-news', 'name': 'Google News'}, 'author': None, 'title': 'Шнуров попрощался с российской элитой: "Ну ты ж куда, кумир?" - Московский Комсомолец', 'description': None, 'url': 'https://news.google.com/__i/rss/rd/articles/CBMiZmh0dHBzOi8vd3d3Lm1rLnJ1L3NvY2lhbC8yMDIyLzAzLzA1L3NobnVyb3YtcG9wcm9zaGhhbHN5YS1zLXJvc3NpeXNrb3ktZWxpdG95LW51LXR5LXpoLWt1ZGEta3VtaXIuaHRtbNIBAA?oc=5', 'urlToImage': None, 'publishedAt': '2022-03-04T22:42:46Z', 'content': None}, {'source': {'id': None, 'name': 'Playground.ru'}, 'author': 'monk70', 'title': 'Крупное обновление Dying Light 2: Stay Human выйдет на следующей неделе - PlayGround.ru', 'description': 'У Techland запланирован важный патч для Dying Light 2, поскольку сегодня разработчики сообщили в Твиттере о грядущем обновлении. Были раскрыты подробности этого патча в дополнение к его предварительному расписанию. Сначала он выйдет на ПК, а...', 'url': 'https://www.playground.ru/dying_light_2/news/krupnoe_obnovlenie_dying_light_2_stay_human_vyjdet_na_sleduyuschej_nedele-1184215', 'urlToImage': 'https://i.playground.ru/e/akP7qR8GZN3sewy_B5s4SQ.webp?600xauto', 'publishedAt': '2022-03-04T22:07:28Z', 'content': '2 , .... (((. 2 , , -, . 60 , , , . , ( 3 )'}, {'source': {'id': None, 'name': 'Gazeta.ru'}, 'author': None, 'title': 'Роскомнадзор заблокировал доступ к Facebook - Газета.Ru', 'description': 'Роскомнадзор принял решение заблокировать доступ к\xa0социальной сети Facebook на\xa0территории России. Об этом сообщает пресс-служба ведомства.', 'url': 'https://www.gazeta.ru/tech/news/2022/03/04/17381329.shtml', 'urlToImage': 'https://img.gazeta.ru/files3/532/13588532/Depositphotos_391074054_l-2015-pic_32ratio_900x600-900x600-94795.jpg', 'publishedAt': '2022-03-04T18:12:53Z', 'content': 'Facebook \xa0 . - .\r\n«4 2022\xa0 \xa0 \xa0 Facebook ( Meta Platforms, Inc.) \xa0 », — \xa0.\r\n , \xa0 2020\xa0 26\xa0 .\r\n« \xa0: «», « », Sputnik, Russia Today, «.» «.», — \xa0, , « \xa0, \xa0 , ».\r\n25 Facebook \xa0 \xa0 \xa0 .\r\n \xa0 \xa0 .\r\n \xa0 \xa0 () Fac… [+14 chars]'}]

usd, eur, news = None, None, None

@app.before_first_request
def bfr():
    global usd, eur, news
    news = requests.get(f'https://newsapi.org/v2/top-headlines?country=ru&apiKey={cfg.NEWS_API}').json()['articles']
    usd = round(requests.get(f'https://freecurrencyapi.net/api/v2/latest?apikey={cfg.CURRENCY_API}&base_currency=USD').json()['data']['RUB'], 2)
    eur = round(requests.get(f'https://freecurrencyapi.net/api/v2/latest?apikey={cfg.CURRENCY_API}&base_currency=EUR').json()['data']['RUB'], 2)

@scheduler.task('interval', id='do_job_1', seconds=600)
def job1():
    global usd, eur
    usd = round(requests.get(f'https://freecurrencyapi.net/api/v2/latest?apikey={cfg.CURRENCY_API}&base_currency=USD').json()['data']['RUB'], 2)
    eur = round(requests.get(f'https://freecurrencyapi.net/api/v2/latest?apikey={cfg.CURRENCY_API}&base_currency=EUR').json()['data']['RUB'], 2)

@scheduler.task('interval', id='do_job_2', seconds=3600)
def job2():
    global news
    news = requests.get(f'https://newsapi.org/v2/top-headlines?country=ru&apiKey={cfg.NEWS_API}').json()['articles']

scheduler.start()


@app.route('/', methods=["GET", "POST"])
def index():
    if session.get('som') == None:
        session['som'] = metric
    if request.method == 'POST':
        data = get_weather_data(request.form['city'], som=session.get('som'))
        #print(data)
        if data['cod'] == '404':
            flash('Город не найден :(')
            return redirect(url_for('index'))
        time = datetime.datetime.now(tz=datetime.timezone(datetime.timedelta(seconds=data['timezone']))).strftime("%H:%M")
        session['city'] = data['name']
        return render_template('weather.html', data=data, time=time, som=session.get('som'), usd=usd, eur=eur, news=random.sample(news, 3))
    data = get_weather_data(session.get('city'), som=session.get('som'))
    time = datetime.datetime.now(tz=datetime.timezone(datetime.timedelta(seconds=data['timezone']))).strftime("%H:%M")
    return render_template('weather.html', data=data, time=time, som=session.get('som'), usd=usd, eur=eur, news=random.sample(news, 3))

@app.route('/options', methods=["GET", "POST"])
def options():
    form = OptionsForm()
    if request.method == 'POST':
        som = form.option.data
        if som == 'standart':
            som = standart
        elif som == 'imperial':
            som = imperial
        else:
            som = metric
        session['som'] = som
        return redirect(url_for('index'))
    return render_template('options.html', form=form)

